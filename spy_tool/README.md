# ARP Spy Tool (局域网瑞士军刀) - 用户手册 v3.1

## 1. 项目简介

**ARP Spy Tool** 是一个基于 Linux 的轻量级网络攻防工具，利用 **ARP 欺骗 (ARP Spoofing)** 原理，对局域网内的特定目标进行流量控制或监听。

它主要针对 OSI 模型第二层（数据链路层），通过向目标设备和网关发送伪造的 ARP 数据包，实现 **中间人攻击 (MITM)**。

### 核心功能
1.  **断网模式 (Ban Mode) [默认]**：
    *   原理：向目标发送虚假的网关 MAC 地址（黑洞地址），并**强制关闭本机流量转发**。
    *   效果：目标设备无法连接互联网（Web、游戏、IM 等），所有流量被静默丢弃。
    *   特点：双向欺骗（同时欺骗目标和网关），打击更彻底。
2.  **监听模式 (Spy Mode)**：
    *   原理：向目标和网关发送本机的真实 MAC 地址，并**自动开启内核 IP 转发**。
    *   效果：目标设备可以正常上网，但所有流量都会流经本机。
    *   内置嗅探：程序会在终端实时打印捕获到的 **HTTP URL** (明文) 和 **DNS 查询**。
    *   配合工具：可配合 **Wireshark** 进行深度流量分析（如提取图片、账号密码）。
3.  **智能网卡选择**：
    *   自动根据目标 IP 判断并选择处于同一网段的网卡，无需手动指定 `-i`。
4.  **高频压制**：
    *   默认以 100ms 的频率发送欺骗包，有效压制现代路由器和操作系统的 ARP 修正机制。
5.  **自动恢复 (Re-ARP)**：
    *   提供 `--restore` 参数，在程序退出时发送正确的 ARP 包修复网络，实现“无痕退出”。

---

## 2. 编译指南

本工具使用 C 语言编写，依赖 `libpcap` 进行底层抓包，依赖 `glib-2.0` 进行参数解析，使用 `pthread` 进行多线程处理。

### 2.1 安装依赖
在编译前，请确保您的系统安装了以下库（以 Ubuntu/Debian 为例）：

```bash
sudo apt update
sudo apt install -y libpcap-dev libglib2.0-dev gcc make
```

### 2.2 编译命令
由于引入了 GLib，编译命令需要链接相应的库。请在源码目录下执行：

```bash
gcc 1.c -o spy_tool $(pkg-config --cflags --libs glib-2.0) -lpcap -pthread
```

*   `1.c`：源代码文件。
*   `-o spy_tool`：输出的可执行文件名。
*   `pkg-config ...`：自动获取 GLib 的头文件路径和链接库。
*   `-lpcap`：链接 pcap 库。
*   `-pthread`：启用 POSIX 线程支持。

---

## 3. 使用说明

本工具需要 **Root 权限** 才能运行（因为需要操作原始套接字 Raw Socket）。

### 3.1 基础用法

**查看帮助：**
```bash
./spy_tool --help
```

**最简单的断网攻击：**
（前提：先用 `nmap` 或 `arp-scan` 找到目标的 IP）
```bash
sudo ./spy_tool -t 192.168.1.100
```

### 3.2 详细参数解释

| 参数 (短/长) | 必选? | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| `-t, --target` | **是** | **目标 IP 地址**。你想攻击的那台设备的 IP。 | `-t 192.168.5.146` |
| `-g, --gateway` | 否 | **网关 IP 地址**。默认会自动读取 `/proc/net/route` 获取。如果网络环境复杂，建议手动指定。 | `-g 192.168.5.1` |
| `-i, --interface` | 否 | **网卡接口**。默认会智能匹配与目标 IP 同网段的网卡（如 `enp3s0`）。 | `-i wlan0` |
| `-m, --spy` | 否 | **开启监听模式**。不加此参数则默认为断网模式。开启后会转发流量并嗅探 HTTP/DNS。 | `-m` |
| `-r, --restore` | 否 | **退出时恢复网络**。程序结束时发送 3 组正确包修复 ARP 表。如果不加，目标会持续断网一段时间。 | `-r` |
| `-s, --interval` | 否 | **发包间隔 (毫秒)**。默认 100ms。越小攻击越猛烈，越大越隐蔽。 | `-s 500` |
| `-v, --verbose` | 否 | **详细模式**。显示每一轮发包的详细日志。 | `-v` |

### 3.3 典型场景示例

**场景一：惩罚蹭网者 (强制断网，冷酷模式)**
*   目标 IP：192.168.5.146
*   行为：双向阻断，退出不管（不恢复）。
```bash
sudo ./spy_tool -t 192.168.5.146
```

**场景二：中间人监听 (配合 Wireshark)**
*   目标 IP：192.168.5.146
*   行为：开启内核转发，流量流经本机，退出时恢复网络（以免被发现）。
```bash
# 1. 启动工具
sudo ./spy_tool -t 192.168.5.146 -m -r

# 2. 另开终端启动 Wireshark (过滤目标IP)
wireshark
# Filter: ip.addr == 192.168.5.146
```

**场景三：针对顽固设备 (高频攻击)**
*   如果默认频率无法断网，尝试提高频率至 10ms 一次。
```bash
sudo ./spy_tool -t 192.168.5.146 -s 10
```

---

## 4. 技术原理与注意事项

### 4.1 MAC 地址解析
程序启动时会发送 ARP Request 询问目标和网关的真实 MAC 地址。如果目标开启了防火墙拦截 ARP 请求，程序可能会报错退出。

### 4.2 欺骗策略
*   **断网模式**：发送的源 MAC 是一个随机生成的地址（如 `34:fd:xx...`），并在本机执行 `sysctl -w net.ipv4.ip_forward=0` 关闭转发。流量到达本机即被丢弃。
*   **监听模式**：发送的源 MAC 是本机真实 MAC，并执行 `sysctl -w net.ipv4.ip_forward=1` 开启转发。流量经过本机路由。

### 4.3 局限性
*   **IPv6**：本工具仅针对 IPv4 ARP 协议。如果目标使用 IPv6 上网，断网可能无效。
*   **静态 ARP**：如果目标电脑绑定了静态 ARP (static entry)，攻击将无效。
*   **HTTPS**：监听模式下，HTTPS 流量的内容是加密的，仅能看到域名 (SNI) 和握手信息。

---

## 5. 免责声明
本工具仅供网络安全学习、渗透测试授权环境下的研究使用。严禁用于非法攻击他人网络或窃取隐私。由此产生的一切法律责任由使用者自行承担。
